# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

AIChat is an all-in-one LLM CLI tool written in Rust, featuring Shell Assistant, CMD & REPL modes, RAG, AI Tools & Agents, and more. This is a fork with additional features for the LASP (Large-Scale AI Systems Programming) final project.

**Repository:** https://github.com/sigoden/aichat (upstream)
**Version:** 0.30.0
**Language:** Rust (Edition 2021)

## Build and Development Commands

### Building
```bash
# Build the project
cargo build

# Build for release (optimized)
cargo build --release

# Run the application
cargo run

# Run with specific arguments
cargo run -- -m gpt-4o "test prompt"
```

### Testing
```bash
# Run all tests
cargo test

# Run tests with output
cargo test -- --nocapture

# Run specific test
cargo test test_name
```

### Code Quality
```bash
# Check code without building
cargo check

# Run clippy for linting
cargo clippy

# Format code
cargo fmt
```

## Architecture

### Core Components

1. **Config System** (`src/config/`)
   - `mod.rs`: Main configuration logic, handles global config, model selection, and role extraction
   - `environments.rs`: **NEW** Environment detection (OS, shell, package manager, system info)
   - `role.rs`: Role definitions and management
   - `session.rs`: Session persistence and management
   - `agent.rs`: AI agent configurations
   - `input.rs`: Input handling and processing

2. **REPL System** (`src/repl/`)
   - `mod.rs`: Main REPL loop, command handling, and **new `.export` command**
   - `completer.rs`: Tab completion
   - `highlighter.rs`: Syntax highlighting
   - `prompt.rs`: Custom REPL prompts

3. **Client System** (`src/client/`)
   - Supports 20+ LLM providers (OpenAI, Claude, Gemini, Ollama, etc.)
   - Each provider has its own module (e.g., `openai.rs`, `claude.rs`, `gemini.rs`)
   - `common.rs`: Shared client utilities
   - `message.rs`: Message formatting and handling

4. **RAG System** (`src/rag/`)
   - Document loading, chunking, embedding, and retrieval
   - Supports multiple document types via external loaders

5. **Function System** (`src/function.rs`)
   - Function calling and tool integration
   - MCP (Model Context Protocol) support

6. **Rendering** (`src/render/`)
   - Markdown rendering with syntax highlighting
   - Stream processing for real-time output

## New Features Added (LASP Final Project)

### 1. Environment Awareness (Auto-Setup)
**Status:** âœ… Fully Implemented

**Implementation:**
- `src/config/environments.rs`: Complete environment detection system
- Detects: OS type, Shell type, Package Manager, CPU cores, Memory, Disk space, GPU
- Automatically injects environment context into AI prompts via `EnvProfile::to_prompt_context()`
- Integration in `src/config/mod.rs`: `Config::extract_role()` method adds environment info to all role prompts

**How it works:**
- When a role is extracted, `EnvProfile::detect()` runs to gather system information
- The environment context is prepended to the role's prompt
- AI models receive XML-formatted environment data: `<user_environment>...</user_environment>`
- This ensures commands generated by AI match the user's actual environment (e.g., `brew` for macOS, `apt` for Ubuntu)

**Files modified:**
- `src/config/environments.rs` (new file)
- `src/config/mod.rs` (environment injection)
- `src/config/role.rs` (added `set_prompt()` method)
- `Cargo.toml` (added dependencies: `sysinfo`, `which`, `ping`)

### 2. Session Export to Markdown
**Status:** âœ… Fully Implemented

**Implementation:**
- New REPL command: `.export [filename]`
- Located in `src/repl/mod.rs`: `export_session_markdown()` function (line ~955)
- Exports current session as a formatted Markdown file
- Default filename: `session-{name}.md`

**Usage:**
```bash
# In REPL mode
.export                    # Export to session-{name}.md
.export my-session.md      # Export to custom filename
```

**Features:**
- Preserves conversation structure
- Includes role/agent information
- Markdown-formatted code blocks
- Timestamps and metadata

### 3. Safe and Reversible Execution
**Status:** âœ… Fully Implemented

**Implementation:**
- New REPL command: `.backup [list|restore|delete|cleanup]`
- New Execute mode options: `p` (Preview), `t` (Tutor)
- Automatic backup system for destructive operations
- Command analysis engine to identify safety risks

**New Modules:**
- `src/utils/backup.rs` (279 lines): Complete backup/restore system with UUID-based tracking
- `src/utils/command_analyzer.rs` (219 lines): Command analysis and safety level detection
- `src/utils/command_tutor.rs` (318 lines): Educational command explanations

**Integration Points:**
- `src/main.rs`: Modified `shell_execute()` function
  - Changed options from [e, r, d, c, q] to [p, e, r, t, c, q]
  - 'p': Preview command impact (shows affected files)
  - 't': Tutor mode (educational explanations)
  - 'e': Execute with automatic backup
- `src/repl/mod.rs`: Added `.backup` command handler
  - `.backup list`: List all backups
  - `.backup restore <id>`: Restore specific backup
  - `.backup delete <id>`: Delete backup
  - `.backup cleanup [count]`: Keep only last N backups

**Features:**
- Pre-execution file backup with SHA256 verification
- Command safety analysis (Read/Write/Delete/System operations)
- Affected file preview
- Rollback support on command failure
- Educational tutor mode with environment-specific notes
- Backup management in REPL mode

## Important Code Patterns

### Environment Detection Flow
```rust
// 1. Detect environment
let env = EnvProfile::detect();

// 2. Generate context for AI
let env_ctx = env.to_prompt_context();

// 3. Inject into prompt
let new_prompt = format!("{}\n\n{}", env_ctx, original_prompt);
role.set_prompt(new_prompt);
```

### Adding New REPL Commands
1. Add command definition to `REPL_COMMANDS` array in `src/repl/mod.rs`
2. Add command handler in the match statement in `handle_command()`
3. Example pattern:
```rust
ReplCommand::new(".mycommand", "Description", AssertState::pass()),

// In handle_command():
".mycommand" => {
    my_command_handler(config, args)?;
}
```

### Working with Sessions
- Sessions are stored in `~/.config/aichat/sessions/`
- Session state includes messages, role, and metadata
- Sessions can be compressed when they exceed `compress_threshold`

### Working with Roles
- Roles define system prompts and model configurations
- Stored in `~/.config/aichat/roles/`
- Can be created dynamically or loaded from YAML files

## Configuration

**Config file location:** `~/.config/aichat/config.yaml`

**Key directories:**
- `~/.config/aichat/roles/` - Role definitions
- `~/.config/aichat/sessions/` - Saved sessions
- `~/.config/aichat/agents/` - Agent configurations
- `~/.config/aichat/rags/` - RAG document stores
- `~/.config/aichat/functions/` - Function definitions

## Testing the New Features

### Test Environment Detection
```bash
# Run aichat and check .info output
cargo run
> .info

# Check if environment context is in prompts
# Use dry-run mode to see the full prompt
cargo run -- --dry-run -c "list files"
```

### Test Session Export
```bash
# Start a session and have a conversation
cargo run
> .session test-session
> Hello, this is a test
> .export test-output.md
# Check that test-output.md was created with proper formatting
```

## Common Development Patterns

### Adding System Information to Environment Detection
1. Add new field to `EnvProfile` struct in `src/config/environments.rs`
2. Implement detection logic in a new function (e.g., `detect_cpu_info()`)
3. Call detection function in `EnvProfile::detect()`
4. Update `to_prompt_context()` to include the new information

### Modifying Prompt Injection
- Environment context injection happens in `Config::extract_role()` in `src/config/mod.rs`
- The format is XML-tagged for clear parsing by LLMs
- Keep the format consistent: `<user_environment>{json}</user_environment>`

## Dependencies of Note

- `reedline`: REPL functionality
- `syntect`: Syntax highlighting
- `serde/serde_yaml/serde_json`: Configuration and serialization
- `tokio`: Async runtime
- `reqwest`: HTTP client for API calls
- `sysinfo`: System information gathering (new)
- `which`: Command availability detection (new)
- `scraper`: HTML parsing for RAG

## Git Workflow

This is a fork with feature branches. Recent commits show:
- `eb1bcac`: feature .export
- `db5cd00`: feature: gpu, mem info
- `4187004`: feature: more sys info
- `60033ee`: feature: env info

## Notes

- The codebase uses Rust's strong type system extensively
- Async operations are handled with Tokio
- Configuration uses YAML for human-readability
- Errors are handled with `anyhow::Result`
- The code follows Rust 2021 edition conventions
- Environment detection should be fast (no network calls in critical path)

---

## Development History

### 2025-12-03: Feature 3 å®Œæˆå¯¦ä½œ

**å®Œæˆé …ç›®ï¼š**
1. âœ… å‰µå»º `src/utils/backup.rs`
   - å®Œæ•´çš„å‚™ä»½/æ¢å¾©ç³»çµ±
   - UUID è­˜åˆ¥ã€SHA256 é©—è­‰
   - å‚™ä»½å­˜æ”¾æ–¼ `~/.aichat_backups/`
   - JSON ç´¢å¼•æª”ç®¡ç†

2. âœ… å‰µå»º `src/utils/command_analyzer.rs`
   - å‘½ä»¤åˆ†æå¼•æ“
   - è­˜åˆ¥æ“ä½œé¡å‹ï¼ˆRead/Write/Delete/System ç­‰ï¼‰
   - å®‰å…¨ç­‰ç´šè©•ä¼°ï¼ˆSafe/Moderate/High/Criticalï¼‰
   - æå–å—å½±éŸ¿çš„æª”æ¡ˆè·¯å¾‘

3. âœ… å‰µå»º `src/utils/command_tutor.rs`
   - æ•™å­¸æ¨¡å¼å¯¦ä½œ
   - å‘½ä»¤çµæ§‹åŒ–è§£æ
   - ç’°å¢ƒç‰¹å®šèªªæ˜
   - å®‰å…¨æç¤ºç”Ÿæˆ

4. âœ… ä¿®æ”¹ `src/main.rs`
   - æ•´åˆ previewã€tutor åŠŸèƒ½åˆ° shell_execute
   - åŸ·è¡Œå‰è‡ªå‹•å‚™ä»½
   - å¤±æ•—æ™‚é¡¯ç¤ºæ¢å¾©æç¤º

5. âœ… ä¿®æ”¹ `src/repl/mod.rs`
   - æ–°å¢ `.backup` å‘½ä»¤
   - å¯¦ä½œ list/restore/delete/cleanup å­å‘½ä»¤

6. âœ… æ›´æ–°æ–‡æª”
   - README.md åæ˜ åŠŸèƒ½ 3 å®Œæˆ
   - åŠŸèƒ½èªªæ˜.md åŠ å…¥å®Œæ•´ä½¿ç”¨ç¯„ä¾‹
   - å‰µå»º IMPLEMENTATION_COMPLETE.md å®Œæˆå ±å‘Š

7. âœ… æ›´æ–° `.gitignore`
   - æ’é™¤å…§éƒ¨é–‹ç™¼æ–‡æª”ï¼ˆWORK_LOG, TESTING_GUIDE ç­‰ï¼‰

**ç¨‹å¼ç¢¼çµ±è¨ˆï¼š**
- æ–°å¢ç¨‹å¼ç¢¼ï¼š1118 è¡Œï¼ˆ4 å€‹æ–°æ¨¡çµ„ï¼‰
- ä¿®æ”¹ç¨‹å¼ç¢¼ï¼š174 è¡Œ
- æ–‡æª”æ›´æ–°ï¼š176 è¡Œ

---

## TODO List

### ğŸ”´ ç«‹å³éœ€è¦ (User Action Required)

1. **ç·¨è­¯æ¸¬è©¦**
   ```bash
   cd /Users/morrisliao/Desktop/git-repo/aichat/aichat
   cargo check          # æª¢æŸ¥èªæ³•
   cargo clippy         # æª¢æŸ¥ lint
   cargo build          # Debug å»ºç½®
   cargo build --release  # Release å»ºç½®
   ```

2. **åŠŸèƒ½æ¸¬è©¦**
   ```bash
   # æ¸¬è©¦ç’°å¢ƒåµæ¸¬
   ./target/release/aichat --info

   # æ¸¬è©¦ Session åŒ¯å‡º
   ./target/release/aichat
   > .session test
   > Hello test
   > .export

   # æ¸¬è©¦å®‰å…¨åŸ·è¡Œæ¨¡å¼
   ./target/release/aichat -e "list files in current directory"
   # æ¸¬è©¦ 'p' (preview)ã€'t' (tutor) é¸é …

   # æ¸¬è©¦å‚™ä»½ç³»çµ±
   ./target/release/aichat
   > .backup list
   ```

3. **Git Commit**
   ```bash
   git add .
   git commit -m "feat: implement Feature 3 - Safe and Reversible Execution

   - Add backup system (src/utils/backup.rs)
   - Add command analyzer (src/utils/command_analyzer.rs)
   - Add command tutor (src/utils/command_tutor.rs)
   - Integrate preview and tutor modes in shell_execute
   - Add .backup REPL command
   - Update documentation (README, åŠŸèƒ½èªªæ˜)
   - All 3 features now 100% complete"

   git push
   ```

### ğŸŸ¡ å¾ŒçºŒæ”¹é€² (Optional Enhancements)

1. **æ¸¬è©¦è¦†è“‹**
   - [ ] ç‚º backup.rs ç·¨å¯«å–®å…ƒæ¸¬è©¦
   - [ ] ç‚º command_analyzer.rs ç·¨å¯«æ¸¬è©¦
   - [ ] ç‚º command_tutor.rs ç·¨å¯«æ¸¬è©¦
   - [ ] æ•´åˆæ¸¬è©¦ï¼ˆend-to-endï¼‰

2. **åŠŸèƒ½å¢å¼·**
   - [ ] æ”¯æ´ç›®éŒ„éè¿´å‚™ä»½ï¼ˆç›®å‰åªå‚™ä»½æª”æ¡ˆï¼‰
   - [ ] å‚™ä»½å£“ç¸®ä»¥ç¯€çœç©ºé–“
   - [ ] å¢é‡å‚™ä»½æ”¯æ´
   - [ ] å‚™ä»½åŠ å¯†é¸é …

3. **æ”¹é€²å‘½ä»¤åˆ†æ**
   - [ ] æ›´ç²¾ç¢ºçš„æª”æ¡ˆè·¯å¾‘æå–ï¼ˆè™•ç†è¤‡é›œ shell èªæ³•ï¼‰
   - [ ] æ”¯æ´æ›´å¤šå‘½ä»¤é¡å‹è­˜åˆ¥
   - [ ] æ”¹é€²å®‰å…¨ç­‰ç´šè©•ä¼°é‚è¼¯

4. **æ–‡æª”å®Œå–„**
   - [ ] ä¸­æ–‡è¨»è§£è£œå……ï¼ˆç›®å‰ç¨‹å¼ç¢¼è¨»è§£ç‚ºè‹±æ–‡ï¼‰
   - [ ] ä½¿ç”¨è€…æ‰‹å†Šç·¨å¯«
   - [ ] é–‹ç™¼è€… API æ–‡æª”

### ğŸŸ¢ å·²å®Œæˆ (Completed)

- [x] åŠŸèƒ½ 1: ç’°å¢ƒè‡ªå‹•åµæ¸¬ï¼ˆEnvironment Auto-Detectionï¼‰
- [x] åŠŸèƒ½ 2: Session åŒ¯å‡ºï¼ˆSession Exportï¼‰
- [x] åŠŸèƒ½ 3: å®‰å…¨åŸ·è¡Œæ¨¡å¼ï¼ˆSafe and Reversible Executionï¼‰
- [x] æ‰€æœ‰æ–‡æª”æ›´æ–°ï¼ˆREADME, åŠŸèƒ½èªªæ˜, CLAUDE.mdï¼‰
- [x] .gitignore æ›´æ–°

---

## Current Status: âœ… All Features Complete

**å°ˆæ¡ˆå®Œæˆåº¦ï¼š** 100%

æ‰€æœ‰ä¸‰å€‹ LASP Final Project åŠŸèƒ½å·²å®Œå…¨å¯¦ä½œä¸¦æ•´åˆã€‚
ä¸‹ä¸€æ­¥ï¼šç”¨æˆ¶éœ€è¦ç·¨è­¯æ¸¬è©¦ä¸¦æäº¤ç¨‹å¼ç¢¼ã€‚
